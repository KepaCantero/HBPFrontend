angular.module("hbpDocumentClient",["bbpConfig","hbpCommon","hbpDocumentClientTemplates"]),angular.module("hbpDocumentClientTemplates",["templates/mini-browser.html"]),angular.module("templates/mini-browser.html",[]).run(["$templateCache",function(a){a.put("templates/mini-browser.html",'<div class="hbp-mini-browser">\n    <ul ng-if="currentEntity.children.list === undefined">\n        <li><bbp-loading class="bbp-browser-loading"/></li>\n    </ul>\n    <ul  ng-if="currentEntity.children.list !== undefined">\n        <li ng-if="!currentEntity.root">\n            <a ng-click="back($event)"><i class="hbp-browser-entity-icon fa fa-level-up"></i>..</a>\n        </li>\n        <li ng-if="currentEntity.children.list.length === 0"><span class="no-entity">Empty</span></li>\n        <li ng-repeat="child in currentEntity.children.list">\n            <a ng-if="isBrowsable(child)" ng-click="browseTo(child, $event)" ng-mouseover="mouseOver(child)">\n                <hbp-icon entity="child"></hbp-icon>\n                {{child._name}}\n                <button ng-if="isSelectable(child)" ng-click="select(child, $event)" class="btn btn-xs btn-default">Select</button>\n            </a>\n            <span ng-if="!isBrowsable(child)" ng-class="{disabled: !isSelectable(child)}" ng-mouseover="mouseOver(child)">\n                <hbp-icon entity="child"></hbp-icon>\n                {{child._name}}\n                <button ng-if="isSelectable(child)" ng-click="select(child, $event)" class="btn btn-xs btn-default">Select</button>\n            </span>\n        </li>\n        <li ng-if="currentEntity.children.hasNext"><a class="hbp-mini-browser-more" ng-click="loadMore()">Load more</a></li>\n    </ul>\n</div>\n')}]),function(){"use strict";angular.module("hbpDocumentClient").directive("hbpMiniBrowser",["hbpEntityStore","hbpProjectStore",function(a,b){return{restrict:"E",templateUrl:"templates/mini-browser.html",link:function(c){c.getChildren=function(d){c.currentEntity.children={list:void 0},d?b.getAll().then(function(b){_.forEach(b.result,function(b){a.getUserAccess(b).then(function(a){b.canRead=a.canRead,b.canWrite=a.canWrite,b.canManage=a.canManage})}),c.currentEntity.children={list:b.result,hasNext:b.hasMore}}):a.getChildren(c.currentEntity.entity).then(function(a){c.currentEntity.children={list:a.result,hasNext:a.hasMore}})},c.entity&&c.entity._parent?(c.currentEntity={root:!1,entity:{_uuid:c.entity._parent}},a.get(c.currentEntity.entity._uuid).then(function(a){c.currentEntity.entity=a,c.getChildren(!1)})):(c.currentEntity={root:!0,entity:null},c.getChildren(!0)),c.back=function(b){b.preventDefault(),c.currentEntity.root||(c.currentEntity.entity._parent?(a.get(c.currentEntity.entity._parent).then(function(a){c.currentEntity.entity=a,c.getChildren(!1)}),c.currentEntity.entity={},c.currentEntity.root=!1):(c.currentEntity.root=!0,c.getChildren(!0)))},c.browseTo=function(a,b){b.preventDefault(),c.currentEntity.root=!1,c.currentEntity.entity=a,c.getChildren(!1)},c.loadMore=function(){var d=c.currentEntity.children.list[c.currentEntity.children.list.length-1]._uuid,e=function(a){a.result.shift(),Array.prototype.push.apply(c.currentEntity.children.list,a.result),c.currentEntity.children.hasNext=a.hasMore};c.currentEntity.root?b.getAll({from:d}).then(e):a.getChildren(c.currentEntity.entity,{from:d}).then(e)},c.select=function(a,b){b.preventDefault(),c.selection&&c.selection()(a)},c.mouseOver=function(a){"function"==typeof c.hovered()&&c.hovered()(a)},c.isBrowsable=function(a){return c.browsable()?c.browsable()(a):"file"!==a._entityType&&"link:file"!==a._entityType},c.isSelectable=function(a){return c.selectable&&c.selectable()?c.selectable()(a):!1}},scope:{selection:"&hbpSelection",selectable:"&hbpSelectable",browsable:"&hbpBrowsable",hovered:"&hbpHovered",entity:"=hbpCurrentEntity"}}}])}(),angular.module("hbpDocumentClient").service("hbpEntityStore",["$http","$q","bbpConfig","hbpUserDirectory","hbpDocumentClientResolveUserIds",function(a,b,c,d,e){"use strict";var f=c.get("api.document.v0"),g={};g.get=function(b){return a.get(f+"/entity/"+b).then(function(a){return a.data})},g.isContainer=function(a){return/.*(folder|release|project)$/.test(a._entityType)},g.getPath=function(a){var c=b.defer(),d=a._name,e=function(){c.reject("Cannot retrieve entity path")};return a._parent?g.get(a._parent).then(function(a){g.getPath(a).then(function(a){d=a+"/"+d,c.resolve(d)},e)},e):c.resolve("/"+d),c.promise};var h=function(a,b){return b&&(a=a.concat(_.map(b===!0?a:b,function(a){return"link:"+a}))),a&&a.length>0?"_entityType="+a.join("+"):void 0};return g.getChildren=function(c,d){var g=b.defer();return d=angular.extend({},d),a.get(f+"/"+c._entityType+"/"+c._uuid+"/children",{params:{filter:h(d.accept,d.acceptLink),sort:d.sort?d.sort:"_name",from:d.from,until:d.until}}).then(function(a){var b=a.data.result;d.resolveUserId&&e(b),g.resolve(a.data)},g.reject,g.notify),g.promise},g.getUserAccess=function(c){var e=b.defer();return b.all({acl:a.get(f+"/"+c._entityType+"/"+c._uuid+"/acl"),user:d.getCurrentUser()}).then(function(a){var b=a.acl.data,c=a.user,d={canRead:!1,canWrite:!1,canManage:!1};_.forEach(b,function(a,b){(b===c.id||c.groups.indexOf(b)>=0)&&(d.canRead=d.canRead||"read"===a||"write"===a||"manage"===a,d.canWrite=d.canWrite||"write"===a||"manage"===a,d.canManage=d.canManage||"manage"===a)}),e.resolve(d)},e.reject),e.promise},g}]),angular.module("hbpDocumentClient").provider("hbpFileStore",function(){"use strict";return{$get:["$http","$q","$log","bbpConfig",function(a,b,c,d){var e=d.get("hbpFileStore.maxFileUploadSize",10485760),f={},g=d.get("api.document.v0"),h=function(a,b){b=b||{};var c="UploadError",d=new Error(c+": "+a+" "+b.message);return d.cause=a,d.statusText=b.message,d.name=c,d.file=b.file,d.entity=b.entity,d},i=function(){return h("Aborted")},j=function(a){return g+"/"+a._entityType.split(":")[0]+"/"+a._uuid},k=function(c,d,e){var f=b.defer();return a.post(g+"/"+c.split(":")[0],d,e).success(function(a){f.resolve(a)}).error(function(a,b){var c;d={message:a&&a.reason},c=0===b?i():a.reason.match(/already exists/)?h("FileAlreadyExistError",d):h("EntityCreationError",d),f.reject(c)}),f.promise},l=function(b){return a.delete(j(b))},m=function(d,e,f){var g=b.defer();return a.post(j(e)+"/content/upload",d,angular.extend({headers:{"Content-Type":"application/octet-stream"}},f)).success(function(a){g.notify({lengthComputable:!0,total:d.size,loaded:d.size}),g.resolve(a)}).error(function(a,b){var f=function(){return 0===b?i():h("UploadError",{message:a.reason,file:d,entity:e})};l(e).then(function(){g.reject(f(a))},function(b){c.error("Unable to remove previously created entity",b),g.reject(f(a))})}),g.promise};return f.upload=function(a,c){c=c||{};var d=b.defer(),f=b.defer();if(d.promise.abort=function(){f.resolve()},a.size>e)return d.reject(h("FileTooBig",{message:"The file `"+a.name+"` is too big("+a.size+" bytes), max file size is "+e+" bytes."})),d.promise;var g={_parent:c.parent&&c.parent._uuid,_name:a.name,_contentType:a.type};return k("file",g).then(function(b){d.notify({lengthComputable:!0,total:a.size,loaded:0}),m(a,b,{timeout:f.promise,uploadProgress:function(a){d.notify(a)}}).then(function(a){d.promise.abort=function(){l(a),f.resolve()},d.resolve(a)},d.reject,d.notify)},d.reject),d.promise},f.requestSignedUrl=function(b){return a.get(g+"/file/"+b+"/content/secure_link").then(function(a){return a.data})},f.getContent=function(b){return a({method:"GET",url:g+"/file/"+b+"/content",transformResponse:function(a){return a}}).then(function(a){return a.data})},f.maxFileSize=function(){return e},f}]}}),angular.module("hbpDocumentClient").service("hbpProjectStore",["$http","$q","bbpConfig","hbpUserDirectory","hbpDocumentClientResolveUserIds",function(a,b,c,d,e){"use strict";var f=c.get("api.document.v0"),g={};return g.getAll=function(c){var d=b.defer();return c=angular.extend({},c),a.get(f+"/project",{params:{sort:c.sort?c.sort:"_name",from:c.from,until:c.until}}).then(function(a){var b=a.data.result;c.resolveUserId&&e(b),d.resolve(a.data)},d.reject,d.notify),d.promise},g}]),angular.module("hbpDocumentClient").factory("hbpDocumentClientResolveUserIds",["hbpUserDirectory",function(a){"use strict";return function(b){var c=_.map(b,"_createdBy");a.get(c).then(function(a){for(var c=0;c<b.length;c++){var d=a[b[c]._createdBy];b[c]._createdByName=d?d.displayName:b[c]._createdBy}})}}]);