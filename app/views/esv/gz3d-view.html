<!-- build:css(.tmp) styles/esv/gz3d-view.css -->
<link rel="stylesheet" href="styles/esv/gz3d-view.css" />
<link rel="stylesheet" href="styles/esv/spiketrain.css" />
<link rel="stylesheet" href="styles/esv/resizeable.css" />
<!-- endbuild -->

  <script id="heightmapVS" type="x-shader/x-vertex">
    varying vec2 vUv;
    varying vec3 vPosition;
    varying vec3 vNormal;

    void main( void ) {
      vUv = uv;
      vPosition = position;
      vNormal = normal;

      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  </script>

  <script id="heightmapFS" type="x-shader/x-fragment">

    uniform sampler2D texture0;
    uniform sampler2D texture1;
    uniform sampler2D texture2;

    uniform float repeat0;
    uniform float repeat1;
    uniform float repeat2;

    uniform float minHeight1;
    uniform float minHeight2;

    uniform float fadeDist1;
    uniform float fadeDist2;

    uniform vec3 ambient;
    uniform vec3 lightDiffuse;
    uniform vec3 lightDir;

    varying vec2 vUv;
    varying vec3 vPosition;
    varying vec3 vNormal;

    float blend(float distance, float fadeDist) {
      float alpha = distance / fadeDist;
      if (alpha < 0.0) {
        alpha = 0.0;
      }
      if (alpha > 1.0) {
        alpha = 1.0;
      }
      return alpha;
    }

    void main()
    {
      // Texture loading
      vec3 diffuse0 = texture2D( texture0, vUv*repeat0 ).rgb;
      vec3 diffuse1 = texture2D( texture1, vUv*repeat1 ).rgb;
      vec3 diffuse2 = texture2D( texture2, vUv*repeat2 ).rgb;

      // Get base texture
      vec3 fragcolor = diffuse0;

      // texture level 1
      fragcolor = mix(
        fragcolor,
        diffuse1,
        blend(vPosition.z - minHeight1, fadeDist1)
      );

      // texture level 2
      fragcolor = mix(
        fragcolor,
        diffuse2,
        blend(vPosition.z - (minHeight1 + minHeight2), fadeDist2)
      );

      vec3 lightDirNorm = normalize(lightDir);
      float intensity = max(dot(vNormal, lightDirNorm), 0.0);
      vec3 vLightFactor = ambient + lightDiffuse * intensity;
      gl_FragColor = vec4(fragcolor.rgb * vLightFactor, 1.0);
    }
  </script>

    <div id="gz3d-body" data-role="page" data-theme="b" data-content-theme="c" class="esv-flex-container esv-flex-greedy-element">
      <!-- Alert popup --->
      <div class="alert alert-warning" ng-show="isJoiningStoppedSimulation">
        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
        Sorry, the simulation you just wanted to join is already stopped.
        <button class="btn btn-warning btn-xs pull-right" ui-sref="esv-web">&times;</button>
      </div>
      <!-- container -->
      <div class="esv-flex-container esv-flex-greedy-element">
        <!-- WEBGL-context -->
        <div data-role="content" id="container" class="esv-flex-greedy-element" style="position: relative">
          <div ng-mousemove="updateHoverInfo($event);" ng-click="toggleScreenChangeMenu(true, $event);" id="container_MainView"></div>
        </div>
        <!-- WEBGL-context -->

        <div class="keyboard-control-info" ng-show="showKeyboardControlInfoDiv"></div>
        <spiketrain server={{rosbridgeWebsocketUrl}} topic={{spikeTopic}} movable resizeable ng-show="showSpikeTrain"></spiketrain>

        <!-- HelpText -->
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.PLAY_BUTTON]='Here you can start the simulation on the server. The simulation will then run until either you stop it or the simulation times out. The timeout is shown in the toolbar, named \'Timeout\'.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.PAUSE_BUTTON]='Here you can pause the simulation on the server.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.STOP_BUTTON]='Here you can stop the simulation on the server.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.RESET_BUTTON]='Here you can reset the simulation on the server. The robot will return to its initial position and the simulation will be paused.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.TIME_DISPLAY]='This shows the simulated time of the experiment on the server \'Simulation time\', the actual elapsed time \'Real time\' and the \'Timeout\', after which the simulation is terminated.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.LIGHT_SLIDER]='With this slider, you can change the global brightness of the lights in the simulation.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.CAMERA_TRANSLATION]='With those controls, you can change the viewpoint of your local camera. By clicking on the left/right/diagonal arrows, pressing the keys (WASD) or the arrow keys, you can move forward/left/backward/right. The up/down arrows, the keys (RF) or (Page-Up,Page-Down) let you move up and down. The circle in the middle lets you reset the position.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.CAMERA_ROTATION]='With those controls, you can change the orientation of your local camera. The center circle lets you reset the orientation. You also can look around by draging the mouse in the 3d-scene.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.SPIKETRAIN]='This button toggles the view for the spike-train visualization.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.ROBOT_VIEW]='This button toggles the view from the robot camera.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.OWNER_DISPLAY]='This information appears when you are not the displayed owner of the experiment and thus you are in a view-only mode.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.EXIT_BUTTON]='Here you can leave the simulation.'">
        <input type="hidden" ng-model="helpText" ng-init="helpText[UI.EDIT_BUTTON]='A click on this button lets you enter the edit mode such that you can change the experiment configuration.'">

        <!-- overlay -->
        <div id="overlay" class="esv-overlay">
          <div class="hbp-toolbar">
            <div ng-if="isOwner" class="hbp-toolbar-action" ng-class="{'highlighted': currentSelectedUIElement === UI.PLAY_BUTTON}" ng-click="(!helpModeActivated) ? updateSimulation(STATE.STARTED) : help(UI.PLAY_BUTTON)" ng-show="(state === STATE.PAUSED) || (state === STATE.INITIALIZED)">
              <i class="glyphicon glyphicon-play"></i>
            </div>
            <div ng-if="isOwner" class="hbp-toolbar-action" ng-class="{'highlighted': currentSelectedUIElement === UI.PAUSE_BUTTON}" ng-click="(!helpModeActivated) ? updateSimulation(STATE.PAUSED) : help(UI.PAUSE_BUTTON)" ng-show="(state === STATE.STARTED)">
              <i class="glyphicon glyphicon-pause"></i>
            </div>
            <div ng-if="isOwner" class="hbp-toolbar-action" ng-class="{'highlighted': currentSelectedUIElement === UI.STOP_BUTTON}" ng-click="(!helpModeActivated) ? updateSimulation(STATE.STOPPED) : help(UI.STOP_BUTTON)" ng-show="(state === STATE.STARTED) || (state === STATE.PAUSED)">
              <i class="glyphicon glyphicon-stop"></i>
            </div>
            <div ng-if="isOwner" class="hbp-toolbar-action" ng-class="{'highlighted': currentSelectedUIElement === UI.RESET_BUTTON}" ng-click="(!helpModeActivated) ? updateSimulation(STATE.INITIALIZED) : help(UI.RESET_BUTTON)" ng-show="(state === STATE.PAUSED)">
              <i class="glyphicon glyphicon glyphicon-repeat"></i>
            </div>
            <div ng-show="(state === STATE.INITIALIZED) || (state === STATE.STARTED) || (state === STATE.PAUSED)">
              <div class="hbp-toolbar-large-tool hbp-time-display" ng-class="{'highlighted': currentSelectedUIElement === UI.TIME_DISPLAY}" ng-click="(!helpModeActivated) ? null : help(UI.TIME_DISPLAY)">
                <div>
                  <div>
                    <span>Simulation time:</span><br/>
                    <span>Real time:</span><br/>
                    <span ng-style="{ color: simTimeoutText !== undefined && simTimeoutText < 60 ? 'red' : '' }">Timeout:</span>
                  </div>
                  <div>
                    <span>{{simulationTimeText | timeDDHHMMSS}}</span><br/>
                    <span>{{realTimeText | timeDDHHMMSS}}</span><br/>
                    <span ng-style="{ color: simTimeoutText !== undefined && simTimeoutText < 60 ? 'red' : '' }">{{simTimeoutText | timeDDHHMMSS}}</span>
                  </div>
                </div>
              </div>
              <div ng-if="isOwner" class="hbp-toolbar-large-tool hidden-xs" ng-class="{'highlighted': currentSelectedUIElement === UI.LIGHT_SLIDER}" ng-click="helpModeActivated && help(UI.LIGHT_SLIDER);">
                <i class="fa fa-lightbulb-o"></i>
                <input id="lightslider" type="range" min="0" max="100" steps="10" value="50" ng-model="sliderPosition" ng-disabled="helpModeActivated"
                       ng-change="updateLightIntensities(sliderPosition)"/>
              </div>
              <!-- camera translation tool -->
              <div class="hbp-toolbar-item hidden-xs hidden-sm esv-remove-from-touchscreen hbp-camera-tool-container" ng-class="{'highlighted': currentSelectedUIElement === UI.CAMERA_TRANSLATION}" ng-click="(helpModeActivated && help(UI.CAMERA_TRANSLATION)) || helpModeActivated || showKeyboardControlInfo();">
                <div class="hbp-camera-tool-controls">
                  <div class="hbp-camera-tool-controls-overlay"><img src="img/esv/translation_icon.png" width=32 height=32></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'moveUp');"
                    ng-mouseup="releaseMove($event, 'moveUp')"
                    ng-mouseleave="releaseMove($event, 'moveUp')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'moveForward');"
                    ng-mouseup="releaseMove($event, 'moveForward');"
                    ng-mouseleave="releaseMove($event, 'moveForward')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'moveLeft');"
                    ng-mouseup="releaseMove($event, 'moveLeft');"
                    ng-mouseleave="releaseMove($event, 'moveLeft')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'initPosition');"
                    ng-mouseup="releaseMove($event, 'initPosition');"
                    ng-mouseleave="releaseMove($event, 'initPosition')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'moveRight');"
                    ng-mouseup="releaseMove($event, 'moveRight');"
                    ng-mouseleave="releaseMove($event, 'moveRight')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'moveBackward');"
                    ng-mouseup="releaseMove($event, 'moveBackward');"
                    ng-mouseleave="releaseMove($event, 'moveBackward')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'moveDown');"
                    ng-mouseup="releaseMove($event, 'moveDown');"
                    ng-mouseleave="releaseMove($event, 'moveDown')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"><img src="img/esv/empty.png"></div>
                </div>
              </div>
              <!-- camera rotation tool -->
              <div class="hbp-toolbar-item hidden-xs hidden-sm esv-remove-from-touchscreen hbp-camera-tool-container" ng-class="{'highlighted': currentSelectedUIElement === UI.CAMERA_ROTATION}" ng-click="helpModeActivated && help(UI.CAMERA_ROTATION);">
                <div class="hbp-camera-tool-controls">
                  <div class="hbp-camera-tool-controls-overlay"><img src="img/esv/rotation_icon.png" width=32 height=32></div>
                  <!-- in each flex little box, we put an 1 pixel image, else the box has a null size. And on Firefox, <img/> is not working -->
                  <div class="fa hbp-camera-tool-controls-grid-third"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'rotateUp');"
                    ng-mouseup="releaseMove($event, 'rotateUp');"
                    ng-mouseleave="releaseMove($event, 'rotateUp')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'rotateRight');"
                    ng-mouseup="releaseMove($event, 'rotateRight');"
                    ng-mouseleave="releaseMove($event, 'rotateRight')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'initRotation');"
                    ng-mouseup="releaseMove($event, 'initRotation');"
                    ng-mouseleave="releaseMove($event, 'initRotation')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'rotateLeft');"
                    ng-mouseup="releaseMove($event, 'rotateLeft');"
                    ng-mouseleave="releaseMove($event, 'rotateLeft')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"
                    ng-mousedown="requestMove($event, 'rotateDown');"
                    ng-mouseup="releaseMove($event, 'rotateDown');"
                    ng-mouseleave="releaseMove($event, 'rotateDown')"><img src="img/esv/empty.png"></div>
                  <div class="fa hbp-camera-tool-controls-grid-third"><img src="img/esv/empty.png"></div>
                </div>
              </div>
              <div class="hbp-toolbar-action" ng-class="{'highlighted': currentSelectedUIElement === UI.SPIKETRAIN}" ng-click="(!helpModeActivated) ? toggleSpikeTrain() : help(UI.SPIKETRAIN);" ng-show="(state === STATE.STARTED) || (state === STATE.PAUSED) || (state === STATE.INITIALIZED)">
                <img src="img/esv/spiketrain_logo.png">
              </div>
              <!-- toggle robot camera view -->
              <div class="hbp-toolbar-action" ng-class="{'highlighted': currentSelectedUIElement === UI.ROBOT_VIEW}" ng-click="(!helpModeActivated) ? toggleRobotView() : help(UI.ROBOT_VIEW);" ng-show="(state === STATE.STARTED) || (state === STATE.PAUSED) || (state === STATE.INITIALIZED)">
                <img src="img/esv/robot_view_icon.png" width=32 height=32>
              </div>
            </div>
            <div ng-if="isOwner === false" class="hbp-toolbar-large-tool-two-lines" ng-class="{'highlighted': currentSelectedUIElement === UI.OWNER_DISPLAY}" ng-click="(!helpModeActivated) ? null : help(UI.OWNER_DISPLAY)">View-Only Mode<br/>Owner: {{owner}}</div>

            <!-- toolbar help icon -->
            <div class="hbp-toolbar-action right-align hide-overflow" ng-click="toggleHelpMode()">
              <i class="fa fa-question-circle fa-2x vertcenter" ng-class="{active: helpModeActivated}"></i>
            </div>
            <!-- toolbar help icon -->

            <!-- exit -->
            <div class="hbp-toolbar-action right-align hide-overflow" ng-class="{'highlighted': currentSelectedUIElement === UI.EXIT_BUTTON}" ng-click="(!helpModeActivated) ? exit('/esv-web') : help(UI.EXIT_BUTTON)">
              <i class="fa fa-sign-out fa-2x vertcenter"></i>
            </div>
            <!-- exit -->

            <!-- indicating the operating mode -->
            <!-- TODO We have yet to decide how this button should actually behave. The current operation mode can
                      easily be retrieved through OPERATION_MODE (options are .VIEW or .EDIT). As of now we simply
                      display the edit button whenever we are in view mode. -->
            <div ng-if="operationMode === OPERATION_MODE.VIEW" ng-class="{'highlighted': currentSelectedUIElement === UI.EDIT_BUTTON}" class="hbp-toolbar-action right-align hide-overflow" ng-click="(!helpModeActivated) ? null : help(UI.EDIT_BUTTON)">
              <i class="fa fa-pencil fa-2x vertcenter"></i>
            </div>
          </div>
        </div>
        <!-- overlay -->

        <!-- context menu -->
        <div id="contextmenu" class="esv-contextmenu" ng-show="isContextMenuShown" ng-style="{ 'left': contextMenuLeft, 'top': contextMenuTop }">
          <ul class="hbp-list-tableview hbp-list-tableview-selectable">
            <li class="hbp-list-tableview-heading">Change Color</li>
            <li class="hbp-list-tableview-entry" ng-click="setColorOnEntity('red'); $event.stopPropagation();">Red</li>
            <li class="hbp-list-tableview-entry" ng-click="setColorOnEntity('blue'); $event.stopPropagation();">Blue</li>
            <li class="hbp-list-tableview-entry" ng-click="toggleScreenChangeMenu(false); $event.stopPropagation();">No Change (Close)</li>
          </ul>
        </div>
        <!-- context menu -->

        <!-- large top-right help icon -->
        <div ng-if="helpModeActivated" class="fa fa-question-circle fa-5x help-icon active" ng-click="toggleHelpMode()"></div>
        <div ng-if="helpModeActivated" class="fa fa-question fa-4x help-icon-inner" ng-click="toggleHelpMode()"></div>
        <!-- large top-right help icon -->
        <!-- back-end versions -->
        <div ng-if="helpModeActivated" class="nrp-versions">
          <div class="text-right">
            <b>Versions</b><br/>
            <b>ESV</b>
            <span> {{versions.hbp_nrp_esv}}</span><br/>
            <b>CLE</b>
            <span> {{versions.hbp_nrp_cle}}</span><br/>
            <b>ExD</b>
            <span> {{versions.hbp_nrp_backend}}</span>
          </div>
        </div>
        <!-- back-end versions -->

        <!-- Description -->
        <div class="help-window" ng-show="helpModeActivated">
          <div>
            <div class="help-title">General User Interface Help:</div>
            <div class="help-text">A description appears when you click on the corresponding user interface element.</div>
            <div class="help-title">Experiment Description:</div>
            <div class="help-text">{{ExperimentDescription}}</div>
            <div collapse="currentSelectedUIElement === UI.UNDEFINED">
              <hr>
              <div class="help-title">UI-Element Description:</div>
              <div class="help-text"><i><b>{{helpDescription}}</b></i></div>
            </div>
          </div>
        </div>
        <!-- Description -->
      </div>
      <!-- container -->
    </div>
    <!-- page -->
